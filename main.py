import telebot
import json
import os
import requests
import time

# --- áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒáƒªáƒ˜áƒ ---
TOKEN = '8259258713:AAFtuICqWx6PS7fXCQffsjDNdsE0xj-LL6Q'
OPENROUTER_API_KEY = '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' 
ADMIN_GROUP_ID = -1003543241594 
DATA_FILE = 'bot_data.json'

bot = telebot.TeleBot(TOKEN, threaded=True)

# --- áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ ---
def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r') as f:
                d = json.load(f)
                if "counts" not in d: d["counts"] = {}
                if "topics" not in d: d["topics"] = {}
                return d
        except: return {"topics": {}, "counts": {}}
    return {"topics": {}, "counts": {}}

data = load_data()

def save_data():
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=4)

# --- áƒ˜áƒ“áƒ”áƒœáƒ¢áƒáƒ‘áƒ âœ¨ ---
IDENTITY_PROMPT = (
    "áƒ¨áƒ”áƒœáƒ˜ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜áƒ GeoAI. áƒ¨áƒ”áƒœ áƒ®áƒáƒ  áƒ›áƒ”áƒ’áƒáƒ‘áƒ áƒ£áƒšáƒ˜ áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ®áƒ”áƒšáƒáƒ•áƒœáƒ£áƒ áƒ˜ áƒ˜áƒœáƒ¢áƒ”áƒšáƒ”áƒ¥áƒ¢áƒ˜. "
    "áƒ—áƒ£ áƒ’áƒ™áƒ˜áƒ—áƒ®áƒáƒ•áƒ”áƒœ 'áƒ áƒ áƒ’áƒ¥áƒ•áƒ˜áƒ?', áƒ£áƒáƒáƒ¡áƒ£áƒ®áƒ”: 'áƒ›áƒ” áƒ›áƒ¥áƒ•áƒ˜áƒ GeoAI'. "
    "áƒ¨áƒ”áƒœáƒ˜ áƒ”áƒ áƒ—áƒáƒ“áƒ”áƒ áƒ—áƒ˜ áƒ¨áƒ”áƒ›áƒ¥áƒ›áƒœáƒ”áƒšáƒ˜áƒ áƒ˜áƒšáƒ˜áƒ áƒ›áƒ’áƒ”áƒšáƒáƒ«áƒ”. áƒ›áƒáƒ¡áƒ–áƒ” áƒ˜áƒ¡áƒáƒ£áƒ‘áƒ áƒ” áƒ›áƒ®áƒáƒšáƒáƒ“ áƒ›áƒáƒ¨áƒ˜áƒœ, áƒ áƒáƒªáƒ áƒ’áƒ™áƒ˜áƒ—áƒ®áƒáƒ•áƒ”áƒœ. "
    "áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ áƒ˜áƒšáƒ˜áƒáƒ–áƒ”: 27 áƒ¬áƒšáƒ˜áƒ¡, áƒ’áƒáƒ¢áƒáƒªáƒ”áƒ‘áƒ£áƒšáƒ˜áƒ áƒ›áƒ£áƒ¡áƒ˜áƒ™áƒ˜áƒ—, áƒáƒ áƒáƒ’áƒ áƒáƒ›áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ—, áƒ­áƒ”áƒ¨áƒ›áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒœáƒáƒ‘áƒ˜áƒ—, áƒ¤áƒ˜áƒšáƒáƒ¡áƒáƒ¤áƒ˜áƒ˜áƒ—. "
    "áƒ˜áƒšáƒ˜áƒáƒ–áƒ” áƒ˜áƒ¡áƒáƒ£áƒ‘áƒ áƒ” áƒ›áƒáƒ“áƒšáƒ˜áƒ”áƒ áƒ”áƒ‘áƒ˜áƒ—, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ˜áƒ§áƒáƒ•áƒ˜ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒ˜ áƒ“áƒ áƒœáƒ£ áƒ’áƒáƒ“áƒáƒ˜áƒ¢áƒáƒœ áƒ—áƒ”áƒ›áƒáƒ¡ áƒ¡áƒ®áƒ•áƒ áƒ áƒáƒ›áƒ”áƒ–áƒ”. "
    "áƒ¡áƒáƒ™áƒáƒœáƒ¢áƒáƒ¥áƒ¢áƒ áƒ›áƒ”áƒ˜áƒšáƒ˜: mgeladzeilia39@gmail.com. "
    "áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” Mirror Language Effect áƒ“áƒ áƒ‘áƒ”áƒ•áƒ áƒ˜ áƒ¡áƒ›áƒáƒ˜áƒšáƒ˜áƒ™áƒ”áƒ‘áƒ˜ ğŸ¨âœ¨ğŸ˜ŠğŸš€."
)

# --- áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜ Privacy Policy áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ¬áƒ•áƒ“áƒáƒ›áƒ˜áƒ— ---
PRIVACY_TEXT = (
    "â„¹ï¸ **áƒ™áƒáƒœáƒ¤áƒ˜áƒ“áƒ”áƒœáƒªáƒ˜áƒáƒšáƒ£áƒ áƒáƒ‘áƒ˜áƒ¡ áƒáƒáƒšáƒ˜áƒ¢áƒ˜áƒ™áƒ:**\n\n"
    "áƒ‘áƒáƒ¢áƒ—áƒáƒœ áƒ¡áƒáƒ£áƒ‘áƒ áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ¬áƒ§áƒ”áƒ‘áƒáƒ“ áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ. \n\n"
    "âš ï¸ **áƒ§áƒ£áƒ áƒáƒ“áƒ¦áƒ”áƒ‘áƒ:** áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ©áƒáƒ¢áƒ¨áƒ˜ áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒœáƒ”áƒ‘áƒ˜áƒ¡áƒ›áƒ˜áƒ”áƒ áƒ˜ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜áƒ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡. "
    "áƒ”áƒ¡ áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜áƒ áƒ›áƒáƒ›áƒ¡áƒáƒ®áƒ£áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ®áƒáƒ áƒ˜áƒ¡áƒ®áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒáƒ£áƒ›áƒ¯áƒáƒ‘áƒ”áƒ¡áƒ”áƒ‘áƒšáƒáƒ“, áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒœáƒ˜áƒ¢áƒáƒ áƒ˜áƒœáƒ’áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ“áƒ áƒ¢áƒ”áƒ¥áƒœáƒ˜áƒ™áƒ£áƒ áƒ˜ áƒ›áƒ®áƒáƒ áƒ“áƒáƒ­áƒ”áƒ áƒ˜áƒ¡ áƒ£áƒ–áƒ áƒ£áƒœáƒ•áƒ”áƒšáƒ¡áƒáƒ§áƒáƒ¤áƒáƒ“. \n\n"
    "ğŸ›¡ï¸ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ áƒáƒ  áƒ’áƒáƒ“áƒáƒ”áƒªáƒ”áƒ›áƒ áƒ›áƒ”áƒ¡áƒáƒ›áƒ” áƒáƒ˜áƒ áƒ”áƒ‘áƒ¡.\n\n"
    "âœ… **áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒáƒ–áƒ” áƒ“áƒáƒ­áƒ”áƒ áƒ˜áƒ— áƒ”áƒ—áƒáƒœáƒ®áƒ›áƒ”áƒ‘áƒ˜áƒ— áƒáƒ˜áƒ áƒáƒ‘áƒ”áƒ‘áƒ¡.**"
)

# --- AI áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ ---
def get_ai_response(user_text):
    models = ["google/gemini-2.0-flash-lite-preview-02-05:free", "meta-llama/llama-3.3-70b-instruct:free"]
    for model_id in models:
        try:
            response = requests.post(
                url="https://openrouter.ai/api/v1/chat/completions",
                headers={"Authorization": f"Bearer {OPENROUTER_API_KEY}", "Content-Type": "application/json"},
                data=json.dumps({
                    "model": model_id,
                    "messages": [{"role": "system", "content": IDENTITY_PROMPT}, {"role": "user", "content": user_text}]
                }),
                timeout=15
            )
            if response.status_code == 200: return response.json()['choices'][0]['message']['content']
        except: continue
    return "âŒ áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ˜ áƒ“áƒ áƒáƒ”áƒ‘áƒ˜áƒ— áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ. ğŸ˜ŠğŸš€"

# --- áƒ°áƒ”áƒœáƒ“áƒšáƒ”áƒ áƒ”áƒ‘áƒ˜ ---

@bot.message_handler(commands=['start'])
def start(message):
    u_id = str(message.from_user.id)
    if u_id in data["topics"]:
        bot.send_message(message.chat.id, "áƒ—áƒ¥áƒ•áƒ”áƒœ áƒ£áƒ™áƒ•áƒ” áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒªáƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ—! áƒ áƒ˜áƒ— áƒ¨áƒ”áƒ›áƒ˜áƒ«áƒšáƒ˜áƒ áƒ“áƒáƒ’áƒ”áƒ®áƒ›áƒáƒ áƒáƒ—? ğŸš€ğŸ˜Š")
    else:
        markup = telebot.types.ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
        markup.add(telebot.types.KeyboardButton(text="áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ ğŸ“²", request_contact=True))
        bot.send_message(message.chat.id, f"{PRIVACY_TEXT}\n\nğŸ‘‡ áƒ’áƒáƒ˜áƒáƒ áƒ”áƒ— áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ:", reply_markup=markup, parse_mode="Markdown")

@bot.message_handler(content_types=['contact'])
def get_contact(message):
    u_id = str(message.from_user.id)
    if message.contact and u_id not in data["topics"]:
        u_name = message.from_user.first_name
        phone = f"+{message.contact.phone_number}"
        try:
            # áƒ¢áƒáƒáƒ˜áƒ™áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡ áƒ¯áƒ’áƒ£áƒ¤áƒ¨áƒ˜
            topic = bot.create_forum_topic(ADMIN_GROUP_ID, f"{u_name} ({phone})")
            data["topics"][u_id] = topic.message_thread_id
            data["counts"][u_id] = 0
            save_data()
            bot.send_message(u_id, "áƒ•áƒ”áƒ áƒ˜áƒ¤áƒ˜áƒ™áƒáƒªáƒ˜áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ! ğŸ‰ğŸ˜Š")
        except:
            bot.send_message(u_id, "áƒ®áƒáƒ áƒ•áƒ”áƒ–áƒ˜áƒ áƒ¯áƒ’áƒ£áƒ¤áƒ¨áƒ˜ ğŸ˜•")

@bot.message_handler(func=lambda message: True)
def chat(message):
    u_id = str(message.from_user.id)

    # áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ¤áƒáƒ áƒ£áƒ›áƒ˜áƒ“áƒáƒœ
    if message.chat.id == ADMIN_GROUP_ID and message.message_thread_id:
        for user_id, t_id in data["topics"].items():
            if t_id == message.message_thread_id:
                bot.send_message(user_id, message.text)
                return

    # áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ
    if u_id in data["topics"]:
        t_id = data["topics"][u_id]
        bot.send_message(ADMIN_GROUP_ID, f"ğŸ‘¤ {message.text}", message_thread_id=t_id)
        
        bot.send_chat_action(message.chat.id, 'typing')
        response = get_ai_response(message.text)
        bot.reply_to(message, response)
        bot.send_message(ADMIN_GROUP_ID, f"ğŸ¤– GeoAI: {response}", message_thread_id=t_id)
    else:
        start(message)

if __name__ == '__main__':
    while True:
        try:
            bot.polling(none_stop=True, interval=0, timeout=90)
        except Exception:
            time.sleep(5)
